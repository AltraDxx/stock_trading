"""Prompt æ¨¡æ¿ç®¡ç†

åŒ…å«é‡åŒ–åˆ†æå¸ˆè§’è‰²è®¾å®šå’Œå„ç±»åˆ†æä»»åŠ¡çš„ Prompt æ¨¡æ¿ã€‚
åŸºäº Chain-of-Thought (CoT) å’Œ Role-Playing æŠ€æœ¯ã€‚
"""

from dataclasses import dataclass
from string import Template
from typing import Optional


# ==================== ç³»ç»Ÿè§’è‰²å®šä¹‰ ====================

QUANT_ANALYST_ROLE = """ä½ æ˜¯ä¸€åä¸ºé¡¶çº§å¯¹å†²åŸºé‡‘å·¥ä½œçš„èµ„æ·±é‡åŒ–ç ”ç©¶å‘˜ï¼Œæ“…é•¿ç»“åˆå®è§‚æµåŠ¨æ€§ä¸å¾®è§‚æŠ€æœ¯å½¢æ€è¿›è¡Œå¤šç»´åº¦åˆ†æï¼Œè´Ÿè´£ç”Ÿæˆã€å¯æ‰§è¡Œã€å¯éªŒè¯ã€å¯å¤ç›˜ã€‘çš„äº¤æ˜“å‰ç ”ç©¶ç»“è®ºã€‚


ã€æ ¸å¿ƒåˆ†æåŸåˆ™ã€‘
1. ç»“è®ºä¼˜å…ˆçº§ï¼šæ¶ˆæ¯é¢ï¼ˆæ”¿ç­–/ä¸šç»©/çªå‘äº‹ä»¶ï¼‰> èµ„é‡‘æµå‘ > æŠ€æœ¯å½¢æ€ > å®è§‚æµåŠ¨æ€§ã€‚é‡å¤§æ¶ˆæ¯å¯ä¸€ç¥¨å¦å†³å…¶ä»–ä¿¡å·
2. å½“ä¸åŒä¿¡å·å‡ºç°å†²çªæ—¶ï¼Œå¿…é¡»æ˜ç¡®æŒ‡å‡ºå†²çªæ¥æºï¼Œå¹¶è¯´æ˜æœ€ç»ˆé‡‡ç”¨å“ªä¸€ç±»ä¿¡å·åŠåŸå› 
3. ç¦æ­¢åœ¨æ•°æ®ç¼ºå¤±çš„æƒ…å†µä¸‹è¿›è¡Œä¸»è§‚è¡¥å…¨æˆ–å¸¸è¯†æ¨æ–­ï¼Œæ•°æ®ä¸è¶³å¿…é¡»æ˜ç¡®æ ‡æ³¨ä¸ºâ€œæ— æ³•åˆ¤æ–­â€

ã€åˆ†æä¸è¡¨è¾¾çº¦æŸã€‘
- æ‰€æœ‰åˆ¤æ–­å¿…é¡»æ˜ç¡®æ ‡æ³¨ä¸ºï¼šåˆ©å¤š / ä¸­æ€§ / åˆ©ç©º
- æ¯ä¸€ä¸ªç»“è®ºéœ€è‡³å°‘å¯¹åº”ä¸€æ¡å¯éªŒè¯çš„æ•°æ®æˆ–äº‹å®
- ä¸å…è®¸ä½¿ç”¨æ¨¡ç³Šè¡¨è¿°ï¼ˆå¦‚â€œå¯èƒ½â€â€œæˆ–è®¸â€â€œåå‘â€ï¼‰ï¼Œé™¤éç”¨äºé£é™©æƒ…æ™¯æ¨æ¼”
- æŠ€æœ¯æŒ‡æ ‡å¿…é¡»è¯´æ˜æ—¶é—´å‘¨æœŸï¼ˆå¦‚æ—¥çº¿/å‘¨çº¿ï¼‰

ã€è¾“å‡ºè§„èŒƒã€‘
- ä½¿ç”¨ Markdown æ ¼å¼è¾“å‡ºï¼Œç»“æ„æ¸…æ™°
- å…³é”®æ•°æ®å¿…é¡»ä»¥è¡¨æ ¼å½¢å¼å‘ˆç°
- ç­–ç•¥å»ºè®®å¿…é¡»å…·å¤‡å¯äº¤æ˜“æ€§ï¼ˆæ–¹å‘ã€ä»“ä½ã€é£æ§ï¼‰
- é£é™©æç¤ºéœ€åŒºåˆ†ï¼šç³»ç»Ÿæ€§é£é™© / æ ‡çš„ç‰¹å¼‚é£é™©

ã€å¤±è´¥å¤„ç†ã€‘
- è‹¥æ ¸å¿ƒæ•°æ®ä¸è¶³ä»¥æ”¯æŒç»“è®ºï¼Œå¿…é¡»è¾“å‡ºã€æ•°æ®ä¸è¶³ï¼Œç­–ç•¥è§‚æœ›ã€‘å¹¶è¯´æ˜ç¼ºå¤±é¡¹
"""


# ==================== åˆ†æä»»åŠ¡ Prompt æ¨¡æ¿ ====================

@dataclass
class PromptTemplate:
    """Prompt æ¨¡æ¿"""
    name: str
    system_prompt: str
    user_template: Template
    description: str


# æ—©ç›˜ç­–ç•¥åˆ†ææ¨¡æ¿
ALPHA_PREDATOR_TEMPLATE = PromptTemplate(
    name="alpha_predator",
    description="å…¨å¸‚åœºé˜¿å°”æ³•æ•è· - æ—©ç›˜ç­–ç•¥åˆ†æ",
    system_prompt=QUANT_ANALYST_ROLE,
    user_template=Template("""# ä»Šæ—¥å¸‚åœºåˆ†æä»»åŠ¡

## æ—¥æœŸ
$trade_date

## å¸‚åœºæ•°æ®è¾“å…¥

### 1. å®è§‚ä¸èµ„é‡‘é¢
$macro_data

### 2. æŒ‡æ•°è¡¨ç°
$index_data

### 3. åŒ—å‘èµ„é‡‘
$northbound_data

### 4. é›†åˆç«ä»·ç‰¹å¾ (9:15-9:25)
$auction_data

### 5. å½“æ—¥é‡å¤§æ–°é—»/äº‹ä»¶
$news_data

## åˆ†æè¦æ±‚

è¯·åŸºäºä»¥ä¸Šæ•°æ®ï¼Œå®Œæˆä»¥ä¸‹åˆ†æå¹¶ç”Ÿæˆç ”æŠ¥ï¼š

1. **æ ¸å¿ƒç»¼è¿°**ï¼šå¸‚åœºè¿è¡Œç‰¹å¾æ¦‚è§ˆï¼Œæ—¥å†…é˜¿å°”æ³•é©±åŠ¨åŠ›åˆ†æ
2. **å®è§‚é‡åŒ–ç¯å¢ƒ**ï¼šæµåŠ¨æ€§æ°´ä½è¯„ä¼°ï¼Œè´§å¸æ”¿ç­–è§£è¯»ï¼Œæ˜¯å¦æ„æˆã€æ–¹å‘æ€§çº¦æŸã€‘
3. **èµ„é‡‘é¢åˆ†æ**ï¼šåŒ—å‘èµ„é‡‘æµå‘ã€è¡Œä¸šåå¥½ï¼Œæ˜¯å¦å½¢æˆã€å¯äº¤æ˜“ä¿¡å·ã€‘
4. **æŠ€æœ¯é¢åˆ†æ**ï¼šæŒ‡æ•° MACD/KDJ çŠ¶æ€ï¼Œå…³é”®æ”¯æ’‘é˜»åŠ›ä½ï¼Œæ˜¯å¦ã€ç¡®è®¤æˆ–å¦å®šã€‘èµ„é‡‘åˆ¤æ–­
5. è‹¥ä¿¡å·å†²çªï¼Œæ˜ç¡®è¯´æ˜å†²çªå¹¶ç»™å‡ºè£å†³
6. **ç­–ç•¥å»ºè®®**ï¼š
   - ç»„åˆé…ç½®æƒé‡å»ºè®®
   - é‡ç‚¹å…³æ³¨æ¿å—/ä¸ªè‚¡
   - é£æ§é˜ˆå€¼è®¾å®š
7. **é£é™©æç¤º**ï¼šå½“æ—¥éœ€è­¦æƒ•çš„é£é™©å› ç´ 

## å¼ºåˆ¶è¾“å‡ºè¦æ±‚ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰
åœ¨æŠ¥å‘Šæœ€å‰éƒ¨ï¼Œå¿…é¡»è¾“å‡ºã€ä»Šæ—¥äº¤æ˜“ç»“è®ºæ‘˜è¦ã€‘ï¼š

### ä»Šæ—¥ç»“è®ºå¡ç‰‡
| é¡¹ç›® | ç»“è®º |
|----|----|
| å¸‚åœºæ–¹å‘ | æ˜ç¡®çœ‹å¤š / ä¸­æ€§ / çœ‹ç©º |
| æ ¸å¿ƒé©±åŠ¨å› ç´  | ä¸è¶…è¿‡3æ¡ |
| ä¸»è¦åšå¤šæ–¹å‘ | æ¿å— / æŒ‡æ•° / èµ„äº§ |
| æ˜ç¡®å›é¿æ–¹å‘ | æ¿å— / é£æ ¼ |
| å»ºè®®æ€»ä»“ä½ | 0%â€“100% |
| å…³é”®é£é™©è§¦å‘æ¡ä»¶ | æ˜ç¡®æ•°å€¼æˆ–äº‹ä»¶ |

---



è¾“å‡ºæ ¼å¼å‚è€ƒé™„å½•ä¸­çš„ç ”æŠ¥æ ·ä¾‹é£æ ¼ã€‚"""),
)


# å¢é‡æ›´æ–°æ¨¡æ¿ï¼ˆé›†åˆç«ä»·åå¿«é€Ÿä¿®æ­£ï¼‰
INCREMENTAL_UPDATE_TEMPLATE = PromptTemplate(
    name="incremental_update",
    description="é›†åˆç«ä»·åå¢é‡æ›´æ–°",
    system_prompt=QUANT_ANALYST_ROLE,
    user_template=Template("""# é›†åˆç«ä»·å¢é‡æ›´æ–°

## é¢„å¤„ç†æŠ¥å‘Šæ‘˜è¦
$pre_report_summary

## é›†åˆç«ä»·å®æ—¶æ•°æ® (9:25-9:30)
$auction_realtime

### å…³é”®å˜åŒ–
- ä»Šæ—¥å¼€ç›˜ä»·: $open_price
- ç«ä»·é‡èƒ½: $auction_volume
- é‡æ¯”: $volume_ratio
- é«˜å¼€ä½å¼€å¹…åº¦: $gap_pct

## æ›´æ–°è¦æ±‚

ä»…é’ˆå¯¹ã€æœ€ç»ˆç­–ç•¥å»ºè®®ã€‘éƒ¨åˆ†è¿›è¡Œå¿«é€Ÿä¿®æ­£ï¼š
1. åŸºäºæœ€æ–°ç«ä»·æ•°æ®ï¼Œè°ƒæ•´ä»Šæ—¥ç­–ç•¥æ–¹å‘
2. æ›´æ–°é‡ç‚¹å…³æ³¨æ ‡çš„
3. è°ƒæ•´é£æ§å‚æ•°

ã€æ›´æ–°çº¦æŸã€‘
- ä¸å…è®¸æ¨ç¿»åŸæœ‰å¸‚åœºæ–¹å‘åˆ¤æ–­ï¼Œé™¤éå‡ºç°ä»¥ä¸‹ä»»ä¸€æƒ…å†µï¼š
  1. é«˜å¼€/ä½å¼€å¹…åº¦è¶…è¿‡ Â±2%
  2. é›†åˆç«ä»·é‡èƒ½è¾ƒå‰ä¸€äº¤æ˜“æ—¥æ˜¾è‘—å¼‚å¸¸ï¼ˆâ‰¥150%ï¼‰
- æ‰€æœ‰è°ƒæ•´å¿…é¡»æ˜ç¡®æŒ‡å‡ºã€ç”±å“ªä¸€é¡¹ç«ä»·æŒ‡æ ‡è§¦å‘ã€‘
- è‹¥ç«ä»·æ•°æ®ä¸è¶³ä»¥æ”¹å˜åŸç»“è®ºï¼Œæ˜ç¡®è¯´æ˜â€œç»´æŒåŸç­–ç•¥â€


ä¿æŒç®€æ´ã€‚"""),
)


# ä¸ªè‚¡æ·±åº¦è¯Šç–—æ¨¡æ¿
DEEP_DIVE_TEMPLATE = PromptTemplate(
    name="deep_dive",
    description="ä¸ªè‚¡æ·±åº¦è¯Šç–—åˆ†æ",
    system_prompt=QUANT_ANALYST_ROLE,
    user_template=Template("""# ä¸ªè‚¡æ·±åº¦è¯Šç–—

## æ ‡çš„ä¿¡æ¯
- è‚¡ç¥¨ä»£ç : $ts_code
- è‚¡ç¥¨åç§°: $stock_name
- æ‰€å±è¡Œä¸š: $industry

## åŸºæœ¬é¢æ•°æ®
$fundamental_data

## æŠ€æœ¯é¢æ•°æ®
$technical_data

## èµ„é‡‘é¢æ•°æ®
$capital_data

## è¿‘æœŸäº‹ä»¶
$events_data

## åˆ†æè¦æ±‚

è¯·å¯¹è¯¥è‚¡ç¥¨è¿›è¡Œå…¨é¢"ä½“æ£€"ã€‚**é‡è¦**ï¼š
1. å…¨æ–‡ä½¿ç”¨ä¸­æ–‡ï¼Œæ ‡ç­¾ä½¿ç”¨"ä¹°å…¥/æŒæœ‰/å–å‡º"
2. **æŠ¥å‘Šå¼€å¤´å…ˆç»™å‡ºç»“è®ºæ€»ç»“è¡¨æ ¼**ï¼Œå†å±•å¼€è¯¦ç»†åˆ†æ

## ğŸ“Š ç»“è®ºæ€»ç»“ï¼ˆæ”¾åœ¨æŠ¥å‘Šæœ€å‰é¢ï¼‰
| é¡¹ç›® | ç»“è®º |
|------|------|
| æ“ä½œå»ºè®® | ä¹°å…¥/æŒæœ‰/å–å‡º |
| ä¿¡å·å¼ºåº¦ | å¼º/ä¸­/å¼± |
| ç›®æ ‡ä»· | XX-XX |
| æ­¢æŸä»· | XX |

### 1. è¡Œä¸šåœ°ä½åˆ†æ
- Alpha/Beta åˆ†ç¦»åº¦è¯„ä¼°
- ç›¸å¯¹è¡Œä¸šå¼ºå¼±

### 2. å¤šå› å­è¯„åˆ†
| å› å­ç±»å‹ | è¯„åˆ†(1-10) | è¯´æ˜ |
|---------|-----------|------|
| ä»·å€¼å› å­ | | |
| æˆé•¿å› å­ | | |
| åŠ¨é‡å› å­ | | |
| è´¨é‡å› å­ | | |

### 2.1ã€å¤šå› å­è¯„åˆ†è§„åˆ™ã€‘
- è¯„åˆ†åŸºäºåŒè¡Œä¸šæ¨ªå‘æ¯”è¾ƒï¼ˆè‡³å°‘5åªå¯æ¯”æ ‡çš„ï¼‰
- è¯„åˆ†éœ€è¯´æ˜ï¼šå¤„äºè¡Œä¸šå‰20% / ä¸­ä½ / å20%


### 3. æŠ€æœ¯å½¢æ€è¯Šæ–­
- å½“å‰æ‰€å¤„é˜¶æ®µï¼ˆç­‘åº•/ä¸Šå‡/æ¨ªç›˜/ä¸‹è·Œï¼‰
- å…³é”®æ”¯æ’‘ä½ä¸é˜»åŠ›ä½
- MACD/KDJ ä¿¡å·çŠ¶æ€

### 4. äº‹ä»¶é©±åŠ¨ç›‘æ§
- è¿‘æœŸè§£ç¦æƒ…å†µ
- è‚¡ä¸œå¢å‡æŒåŠ¨æ€
- é‡ç»„/å®šå¢è¿›å±•

### 5. ç»¼åˆè¯„çº§
- **è¯„çº§**: ä¹°å…¥ / æŒæœ‰ / å–å‡º
- **ç›®æ ‡ä»·åŒºé—´**: 
- **æŒä»“å»ºè®®å‘¨æœŸ**: 

### 5.1ã€ç»¼åˆè¯„çº§çº¦æŸã€‘
- Buyï¼šéœ€è‡³å°‘æ»¡è¶³â€œèµ„é‡‘é¢ + æŠ€æœ¯é¢â€åŒé‡ç¡®è®¤
- Holdï¼šä¿¡å·å†²çªæˆ–è¶‹åŠ¿ä¸æ˜
- Sellï¼šè¶‹åŠ¿æ˜ç¡®å‘ä¸‹æˆ–é‡å¤§è´Ÿé¢äº‹ä»¶

### 6. æƒ…æ™¯æ¨æ¼”
| æƒ…æ™¯ | è§¦å‘æ¡ä»¶ | ç›®æ ‡ä½ | æ¦‚ç‡ |
|-----|---------|-------|------|
| ä¸Šæ¶¨æƒ…æ™¯ | | | |
| ä¸­æ€§æƒ…æ™¯ | | | |
| ä¸‹è·Œæƒ…æ™¯ | | | |

### 7. é£é™©æç¤º
æ˜ç¡®åˆ—å‡ºè¯¥è‚¡ç¥¨çš„ä¸»è¦é£é™©å› ç´ ã€‚"""),
)


# è§„åˆ™å¼•æ“é™çº§è¾“å‡ºæ¨¡æ¿ï¼ˆå½“ LLM è¶…æ—¶æ—¶ä½¿ç”¨ï¼‰
FALLBACK_TEMPLATE = """# ç«ä»·å¼‚åŠ¨å¿«æŠ¥ (è§„åˆ™å¼•æ“æ¨¡å¼)

> âš ï¸ æ³¨æ„ï¼šæœ¬æŠ¥å‘Šç”±è§„åˆ™å¼•æ“è‡ªåŠ¨ç”Ÿæˆï¼Œæœªç» AI æ¶¦è‰²

## ç”Ÿæˆæ—¶é—´
{timestamp}

## é«˜å¼€å¼‚åŠ¨æ¦œ (é«˜å¼€ > 3% ä¸” é‡æ¯” > 5)
{high_open_list}

## æ¿å—èµ„é‡‘å‡€æµå…¥ TOP5
{sector_inflow_top5}

## åŒ—å‘èµ„é‡‘åŠ¨æ€
{northbound_summary}

---
*æœ¬æŠ¥å‘ŠåŸºäºç¡¬ç¼–ç è§„åˆ™ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒã€‚è¯¦ç»†åˆ†æè¯·ç­‰å¾… AI æŠ¥å‘Šã€‚*
"""


# æ¿å—åˆ†ææ¨¡æ¿ - è¾“å‡ºç»“æ„åŒ– JSON
SECTOR_ANALYSIS_TEMPLATE = PromptTemplate(
    name="sector_analysis",
    description="çƒ­é—¨æ¿å—åˆ†æ - è¾“å‡ºç»“æ„åŒ–æ•°æ®",
    system_prompt=QUANT_ANALYST_ROLE,
    user_template=Template("""# ä»Šæ—¥æ¿å—åˆ†æä»»åŠ¡

## æ—¥æœŸ
$trade_date

## å¸‚åœºæ•°æ®

### æ¿å—èµ„é‡‘æµå‘
$sector_flow_data

### å¤§ç›˜æŒ‡æ•°
$index_data

### åŒ—å‘èµ„é‡‘
$north_flow_data

## åˆ†æè¦æ±‚

è¯·åˆ†æå½“å‰å¸‚åœºçƒ­é—¨æ¿å—ï¼Œæ‰¾å‡ºæœ€å€¼å¾—å…³æ³¨çš„æ¿å—ã€‚

ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºï¼Œä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ï¼š

```json
{
  "market_summary": "ä»Šæ—¥å¸‚åœºæ•´ä½“ç‚¹è¯„ï¼ˆä¸è¶…è¿‡100å­—ï¼‰",
  "market_direction": "çœ‹å¤š/ä¸­æ€§/çœ‹ç©º",
  "sectors": [
    {
      "name": "æ¿å—åç§°",
      "change_pct": 2.35,
      "money_flow": 12.5,
      "hot_level": "é«˜/ä¸­/ä½",
      "signal": "åˆ©å¤š/ä¸­æ€§/åˆ©ç©º",
      "reason": "æ¨èç†ç”±ï¼ˆä¸è¶…è¿‡50å­—ï¼‰"
    }
  ],
  "risk_warning": "é£é™©æç¤º"
}
```

ã€çº¦æŸã€‘
- sectors æ•°ç»„æŒ‰æ¨èä¼˜å…ˆçº§æ’åºï¼Œæœ€å¤šè¿”å› 8 ä¸ªæ¿å—
- money_flow å•ä½ä¸ºäº¿å…ƒï¼Œæ­£æ•°è¡¨ç¤ºå‡€æµå…¥ï¼Œè´Ÿæ•°è¡¨ç¤ºå‡€æµå‡º
- å¿…é¡»ç»™å‡ºæ˜ç¡®çš„ signal åˆ¤æ–­ï¼Œç¦æ­¢æ¨¡ç³Šè¡¨è¿°
"""),
)


# è‚¡ç¥¨æ¨èæ¨¡æ¿ - è¾“å‡ºç»“æ„åŒ– JSON
STOCK_RECOMMENDATION_TEMPLATE = PromptTemplate(
    name="stock_recommendation",
    description="ä¸ªè‚¡æ¨è - è¾“å‡ºç»“æ„åŒ–æ•°æ®",
    system_prompt=QUANT_ANALYST_ROLE,
    user_template=Template("""# ä¸ªè‚¡æ¨èä»»åŠ¡

## æ—¥æœŸ
$trade_date

## ç”¨æˆ·é€‰æ‹©çš„æ¿å—
$selected_sectors

## æ¿å—å†…è‚¡ç¥¨æ•°æ®

### å®æ—¶è¡Œæƒ…
$stock_quotes

### èµ„é‡‘æµå‘
$stock_money_flow

### æŠ€æœ¯æŒ‡æ ‡
$stock_technicals

## æ¨èè¦æ±‚

è¯·åœ¨ç”¨æˆ·é€‰æ‹©çš„æ¿å—ä¸­ï¼Œæ¨èæœ€å€¼å¾—ä¹°å…¥çš„è‚¡ç¥¨ã€‚

ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºï¼Œä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ï¼š

```json
{
  "analysis_summary": "æ•´ä½“åˆ†æç‚¹è¯„ï¼ˆä¸è¶…è¿‡100å­—ï¼‰",
  "recommendations": [
    {
      "rank": 1,
      "ts_code": "000001.SZ",
      "name": "è‚¡ç¥¨åç§°",
      "sector": "æ‰€å±æ¿å—",
      "signal": "ä¹°å…¥",
      "score": 85,
      "current_price": 12.50,
      "buy_price": 12.00,
      "sell_price": 15.00,
      "stop_loss_price": 11.00,
      "position_strategy": {
        "initial_pct": 30,
        "add_condition": "å›è°ƒè‡³12.0é™„è¿‘åŠ ä»“20%",
        "max_pct": 50
      },
      "hold_period": "5-10ä¸ªäº¤æ˜“æ—¥",
      "entry_timing": "å»ºè®®å›è°ƒè‡³æ”¯æ’‘ä½12.0é™„è¿‘åˆ†æ‰¹å»ºä»“",
      "reasons": [
        "æ¶ˆæ¯é¢ï¼šå…¬å¸å‘å¸ƒåˆ©å¥½å…¬å‘Š...",
        "èµ„é‡‘é¢ï¼šä¸»åŠ›å‡€æµå…¥ 2.3 äº¿",
        "æŠ€æœ¯é¢ï¼šMACD æ—¥çº¿é‡‘å‰ï¼Œå‡çº¿å¤šå¤´æ’åˆ—"
      ],
      "sell_criteria": {
        "min_loss_pct": 10,
        "max_score_threshold": 60,
        "bad_sectors": ["æˆ¿åœ°äº§", "é“¶è¡Œ"],
        "reason": "å½“å‰å¸‚åœºé£æ ¼åå‘æˆé•¿ï¼Œå»ºè®®ç½®æ¢æ‰æ·±å¥—çš„åœ°äº§è‚¡ï¼Œæ‹¥æŠ±ä¸»çº¿ã€‚"
      },
      "replacement_advice": "å»ºè®®å–å‡º [å…·ä½“æŒä»“ç‰¹å¾/æ¿å—] çš„è‚¡ç¥¨ä»¥è°ƒä»“ä¹°å…¥ã€‚ä¾‹å¦‚ï¼šå»ºè®®å–å‡ºå½“å‰äºæŸè¶…è¿‡10%ã€æˆ–å±äº [å¼±åŠ¿æ¿å—] çš„ä¸ªè‚¡ã€‚",
      "risk_factors": [
        "å¤§ç›˜ç³»ç»Ÿæ€§å›è°ƒé£é™©",
        "æ¿å—è½®åŠ¨é£é™©"
      ]
    }
  ],
  "risk_warning": "æŠ•èµ„æœ‰é£é™©ï¼Œä»¥ä¸Šå»ºè®®ä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®"
}
```

ã€å­—æ®µè¯´æ˜ã€‘
- buy_price: å»ºè®®ä¹°å…¥ä»·ä½ï¼ˆé¢„è®¡åœ¨æ­¤ä»·ä½é™„è¿‘ä¹°å…¥è¾ƒä¸ºåˆé€‚ï¼‰
- sell_price: ç›®æ ‡å–å‡ºä»·ä½ï¼ˆé¢„æœŸè‚¡ä»·å¯èƒ½åˆ°è¾¾çš„ä½ç½®ï¼‰
- stop_loss_price: æ­¢æŸä»·ä½ï¼ˆè·Œç ´æ­¤ä»·ä½å»ºè®®æ­¢æŸï¼‰
- position_strategy: ä»“ä½ç­–ç•¥
  - initial_pct: åˆå§‹åº•ä»“æ¯”ä¾‹ï¼ˆ0-100ï¼‰
  - add_condition: åŠ ä»“æ¡ä»¶å’Œæ¯”ä¾‹è¯´æ˜
  - max_pct: æœ€å¤§ä»“ä½å æ¯”

ã€çº¦æŸã€‘
- recommendations æ•°ç»„æŒ‰æ¨èä¼˜å…ˆçº§æ’åºï¼Œæœ€å¤šè¿”å› 5 åªè‚¡ç¥¨
- score è¯„åˆ†èŒƒå›´ 0-100ï¼Œä»£è¡¨ç»¼åˆæ¨èå¼ºåº¦
- ä»“ä½ç­–ç•¥å¿…é¡»æ ¹æ®ä¸ªè‚¡èµ°åŠ¿ç‰¹ç‚¹åˆ¶å®šï¼Œä¸èƒ½æ‰€æœ‰è‚¡ç¥¨ç›¸åŒã€‚
- å¿…é¡»æ˜ç¡®ç»™å‡ºå»ºè®®çš„ initial_pct (åˆå§‹ä»“ä½æ¯”ä¾‹)ï¼Œä¾‹å¦‚ 20 ä»£è¡¨ 20%ã€‚
- åœ¨ add_condition ä¸­å…·ä½“è¯´æ˜åŠ ä»“é€»è¾‘ã€‚
- signal åªèƒ½ä¸ºï¼šä¹°å…¥ / è§‚æœ› / å›é¿
- reasons è‡³å°‘åŒ…å« 2 æ¡å¯éªŒè¯çš„ç†ç”±ï¼Œæ¶ˆæ¯é¢ç†ç”±ä¼˜å…ˆå±•ç¤º
- sell_criteria: å¿…é¡»æä¾›ç»“æ„åŒ–çš„å–å‡º/æ¢ä»“æ ‡å‡†ï¼Œç”¨äºç³»ç»Ÿè‡ªåŠ¨åŒ¹é…ç”¨æˆ·çš„æŒä»“ã€‚
  - min_loss_pct: å»ºè®®å–å‡ºçš„äºæŸé˜ˆå€¼ï¼ˆå¦‚ 10 è¡¨ç¤ºäºæŸè¶…è¿‡ 10% å»ºè®®å–å‡ºï¼‰
  - max_score_threshold: å»ºè®®å–å‡ºçš„è¯„åˆ†é˜ˆå€¼ï¼ˆå¦‚ 60 è¡¨ç¤ºè¯„åˆ†ä½äº 60 å»ºè®®å–å‡ºï¼‰
  - bad_sectors: å»ºè®®è§„é¿çš„æ¿å—åˆ—è¡¨ï¼ˆå¦‚ ["æˆ¿åœ°äº§", "é“¶è¡Œ"]ï¼‰
  - reason: æ¢ä»“çš„å…·ä½“ç†ç”±ï¼ˆå¦‚â€œå½“å‰å¸‚åœº[æ¿å—A]èµ°å¼±ï¼Œå»ºè®®ç½®æ¢â€ï¼‰
- replacement_advice: ç»™ç”¨æˆ·çœ‹çš„äººæ€§åŒ–æ¢ä»“å»ºè®®æ–‡æœ¬ã€‚
- è‹¥æ•°æ®ä¸è¶³æ— æ³•ç»™å‡ºæ¨èï¼Œè¿”å›ç©ºçš„ recommendations æ•°ç»„å¹¶åœ¨ analysis_summary ä¸­è¯´æ˜åŸå› 
"""),
)


def get_prompt_template(name: str) -> Optional[PromptTemplate]:
    """è·å– Prompt æ¨¡æ¿
    
    Args:
        name: æ¨¡æ¿åç§°
        
    Returns:
        æ¨¡æ¿å¯¹è±¡ï¼Œæœªæ‰¾åˆ°è¿”å› None
    """
    templates = {
        "alpha_predator": ALPHA_PREDATOR_TEMPLATE,
        "incremental_update": INCREMENTAL_UPDATE_TEMPLATE,
        "deep_dive": DEEP_DIVE_TEMPLATE,
        "sector_analysis": SECTOR_ANALYSIS_TEMPLATE,
        "stock_recommendation": STOCK_RECOMMENDATION_TEMPLATE,
    }
    return templates.get(name)


def render_prompt(template: PromptTemplate, **kwargs) -> str:
    """æ¸²æŸ“ Prompt
    
    Args:
        template: æ¨¡æ¿å¯¹è±¡
        **kwargs: æ¨¡æ¿å˜é‡
        
    Returns:
        æ¸²æŸ“åçš„ Prompt å­—ç¬¦ä¸²
    """
    return template.user_template.safe_substitute(**kwargs)

# æŒä»“è¯Šæ–­æ¨¡æ¿
PORTFOLIO_DIAGNOSE_TEMPLATE = PromptTemplate(
    name="portfolio_diagnose",
    description="æŒä»“è¯Šæ–­ - æ‰¹é‡ä½“æ£€ä¸æ“ä½œå»ºè®®",
    system_prompt=QUANT_ANALYST_ROLE,
    user_template=Template("""# æŒä»“ç»„åˆæ·±åº¦è¯Šæ–­

## ç»„åˆè´¦æˆ·æ¦‚å†µ
- æ€»èµ„äº§ï¼š$total_capital
- æŒä»“å¸‚å€¼ï¼š$total_market_value
- å¯ç”¨èµ„é‡‘ï¼š$available_capital
- ä»“ä½å æ¯”ï¼š$position_ratio

## æŒä»“æ˜ç»†æ•°æ®
$positions_data

## è¯Šæ–­è¦æ±‚

è¯·å¯¹ä¸Šè¿°æŒä»“è¿›è¡Œé€ä¸€è¯Šæ–­ã€‚**å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ ¼å¼è¦æ±‚**ï¼Œä¸è¦ä½¿ç”¨é•¿ç¯‡å¤§è®ºçš„æ®µè½ã€‚

### ã€æŒä»“è¯Šæ–­æ‘˜è¦è¡¨ã€‘ï¼ˆå¿…é¡»æ”¾åœ¨æœ€å¼€å¤´ï¼‰
| è‚¡ç¥¨åç§° | ä»£ç  | ç›ˆäº | å»ºè®®æ“ä½œ | ä¿¡å·å¼ºåº¦ | æ ¸å¿ƒç†ç”± |
|---|---|---|---|---|---|
| è‚¡ç¥¨A | 000001.SZ | +5.2% | ğŸŸ¢ ä¹°å…¥/åŠ ä»“ | é«˜ | ... |
| è‚¡ç¥¨B | 600000.SH | -12.5% | ğŸ”´ å–å‡º/æ­¢æŸ | é«˜ | ... |
| è‚¡ç¥¨C | ... | ... | ğŸŸ¡ æŒæœ‰/è§‚æœ› | ä¸­ | ... |

---

### ä¸ªè‚¡è¯¦ç»†è¯Šæ–­ï¼ˆæ¯åªè‚¡ç¥¨ä¸€ä¸ªç®€çŸ­ç« èŠ‚ï¼‰

#### [è‚¡ç¥¨åç§°] ([ä»£ç ])
- **å½“å‰çŠ¶æ€**ï¼š[ä¸€å¥è¯æ¦‚æ‹¬ï¼Œå¦‚â€œç¼©é‡å›è°ƒï¼Œæ”¯æ’‘ä½æœ‰æ•ˆâ€]
- **æ“ä½œå»ºè®®**ï¼š**[æ“ä½œæŒ‡ä»¤]** (å¿…é¡»å…·ä½“ï¼Œå¦‚ï¼šå»ºè®®å‡ä»“ 50%ã€æ¸…ä»“å–å‡ºã€åŠ ä»“ 1000 è‚¡)
- **ç­–ç•¥è¯¦æƒ…**ï¼š
  - [ ] å…³é”®æ”¯æ’‘ä½ï¼šXX
  - [ ] å…³é”®å‹åŠ›ä½ï¼šXX
  - [ ] æ­¢æŸ/æ­¢ç›ˆä½ï¼šXX
- **è¯Šæ–­é€»è¾‘**ï¼š
  - **æŠ€æœ¯é¢**ï¼š[ç®€ç»ƒçš„ bullet point]
  - **åŸºæœ¬/æ¶ˆæ¯é¢**ï¼š[ç®€ç»ƒçš„ bullet point]

---

### æ€»ä½“æ“ä½œå»ºè®®
- **ä»“ä½ç®¡ç†**ï¼š[å»ºè®®æ€»ä»“ä½æ§åˆ¶åœ¨å¤šå°‘]
- **é£æ ¼è°ƒæ•´**ï¼š[å¦‚â€œå»ºè®®ä»[æ¿å—A]åˆ‡æ¢è‡³[æ¿å—B]â€]
- **é£é™©æç¤º**ï¼š[å…·ä½“çš„é£é™©ç‚¹]
"""),
)


def get_prompt_template(name: str) -> Optional[PromptTemplate]:
    """è·å– Prompt æ¨¡æ¿
    
    Args:
        name: æ¨¡æ¿åç§°
        
    Returns:
        æ¨¡æ¿å¯¹è±¡ï¼Œæœªæ‰¾åˆ°è¿”å› None
    """
    templates = {
        "alpha_predator": ALPHA_PREDATOR_TEMPLATE,
        "incremental_update": INCREMENTAL_UPDATE_TEMPLATE,
        "deep_dive": DEEP_DIVE_TEMPLATE,
        "sector_analysis": SECTOR_ANALYSIS_TEMPLATE,
        "stock_recommendation": STOCK_RECOMMENDATION_TEMPLATE,
        "portfolio_diagnose": PORTFOLIO_DIAGNOSE_TEMPLATE,
    }
    return templates.get(name)
